# Глава 5: Проектирование согласованного хеширования

## Введение
В этой главе рассматривается согласованное хеширование — метод, необходимый для горизонтального масштабирования, позволяющая эффективно распределять запросы и данные между серверами. Оно минимизирует перераспределение данных при добавлении или удалении серверов и обеспечивает равномерное распределение нагрузки, избегая перегрузки отдельных серверов.

## Проблема перераспределения (Rehashing)
### Объяснение
При традиционном хешировании, например `serverIndex = hash(key) % N`, возникают проблемы при изменении числа серверов. Например:
- При удалении сервера большинство ключей перераспределяется, что вызывает промахи кэша.
- При добавлении сервера происходит избыточное перераспределение ключей.

  <img src="./images/server-hashing.png"  alt="Хеширование серверов" width="450">

- Такой подход работает только при фиксированном количестве серверов. Однако проблемы возникают при добавлении или удалении серверов.

  <img src="./images/server-hashing-miss.png"  alt="Промах при хешировании" width="450">

### Основная проблема
Перераспределение большинства ключей при изменении числа серверов приводит к неэффективности и перегрузке.

## Согласованное хеширование
### Определение
Согласованное хеширование обеспечивает перераспределение только части ключей при добавлении или удалении серверов. Это минимизирует сбои и упрощает масштабирование.

### Основные понятия
1. **Хеш-пространство и кольцо:** Хеш-пространство представлено как непрерывное кольцо, где хеш-значения распределены от `0` до `2^160-1` (например, с использованием SHA-1). Соединяя концы, получаем кольцо.
    <p align="center">
    <img src="./images/hash-ring.png"  alt="Хеш-кольцо" width="450">
    </p>

- Используя ту же хеш-функцию `f`, серверы отображаются на кольце по их IP-адресу или имени с использованием той же хеш-функции.

    <p align="center">
    <img src="./images/server-ring.png"  alt="Кольцо с серверами" width="450">
    </p>

1. **Поиск сервера**
- Сервер для ключа находится при движении по кольцу по часовой стрелке до первого встреченного сервера.

  <p align="center">
  <img src="./images/server-lookup.png"  alt="Поиск сервера" width="450">
  </p>

2. **Добавление и удаление серверов**
- При добавлении сервера перераспределяются только ближайшие к нему ключи.

  <p align="center">
  <img src="./images/adding-server.png"  alt="Добавление сервера" width="450">
  </p>

- При удалении сервера перераспределяются только ключи из его диапазона.

  <p align="center">
  <img src="./images/removing-server.png"  alt="Удаление сервера" width="450">
  </p>

## Проблемы и решения
### Две проблемы базового подхода
1. **Неравномерный размер сегментов:** Разные серверы могут обслуживать сегменты разной длины.
2. **Неравномерное распределение ключей:** Некоторые серверы получают значительно больше ключей, чем другие.

### Решение: Виртуальные узлы
- Каждый сервер представлен несколькими виртуальными узлами, равномерно распределёнными по кольцу.
- Виртуальные узлы улучшают распределение и балансировку нагрузки. Чем больше виртуальных узлов, тем равномернее распределение.

  <p align="center">
  <img src="./images/virtual-nodes.png"   alt="Виртуальные узлы" width="450">
  </p>

## Затронутые ключи
Когда сервера добавляются или удаляются:
- **Добавление сервера:** Затрагиваются ключи между новым сервером и его предшественником.
  В следующем примере сервер s4 добавлен на кольцо. Затронутый диапазон — от s3 до s4. Все ключи в этом диапазоне переназначаются серверу s4.

  <p align="center">
  <img src="./images/server-addition.png"   alt="Добавление сервера" width="450">
  </p>

- **Удаление сервера:** Затрагиваются ключи между удаляемым сервером и его предшественником.
  В примере ниже сервер s1 удаляется. Все ключи от s0 до s1 должны быть переназначены серверу s2.

  <p align="center">
  <img src="./images/server-removed.png"   alt="Удаление сервера" width="450">
  </p>

## Преимущества согласованного хеширования
- **Минимальное перераспределение:** Переназначается лишь часть ключей.
- **Масштабируемость:** Позволяет горизонтальное масштабирование.
- **Избежание перегрузок:** Обеспечивает равномерное распределение данных и предотвращает перегрузку серверов.

## Применение в реальных системах
- Amazon Dynamo DB
- Apache Cassandra
- Discord
- Akamai CDN
- Maglev Load Balancer

