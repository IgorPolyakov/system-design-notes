# Глава 8: Проектирование сервиса сокращения URL

## Введение
В этой главе обсуждается проектирование сервиса сокращения URL, аналогичного TinyURL. Основные цели системы включают **сокращение URL**, **перенаправление** и **высокую масштабируемость** для обработки больших объемов трафика.

### Требования
- Сокращенные URL должны быть **уникальными** и как можно **короче**.
- Обрабатывать до 100 миллионов запросов на генерацию URL в день с поддержкой в течение 10 лет.
- Поддерживать эффективные операции чтения с соотношением чтения к записи 10:1.
- Хранить 365 миллиардов записей, что требует примерно 365 ТБ хранилища за 10 лет.

---

## Шаг 1: Высокоуровневое проектирование

### Конечные точки API
1. **Сокращение URL:**
   - Конечная точка: `POST api/v1/data/shorten`
   - Параметры: `{longUrl: longURLString}`
   - Возвращает: `shortURL`

2. **Перенаправление URL:**
   - Конечная точка: `GET api/v1/shortUrl`
   - Возвращает: `longURL` для перенаправления.

    <p align="center">
    <img src="./images/url-redirection.png" alt="URL Redirection" width="600">
    </p>

### Перенаправление URL
- **301 Redirect:** (Постоянное перенаправление) 301 redirect показывает, что запрошенный URL «постоянно» перенаправлен на исходный (длинный) URL. Браузер кеширует ответ, и
последующие запросы на тот же URL не будут отправляться на сервис сокращения.
- **302 Redirect:** (Временное перенаправление) Временное; полезно для аналитики, например, для отслеживания кликов.

### Сокращение URL
<p align="center">
    <img src="./images/url-shortening.png" alt="URL Shortening" width="400">
</p>

- Использовать **хеш-функцию** для генерации короткого URL, отображающую длинные URL в уникальные сокращенные версии.
- Хеш-функция должна удовлетворять следующим требованиям:
  - Каждый длинный URL должен быть преобразован в одно значение хеша.
  - Каждое хеш-значение должно позволять получить обратно длинный URL.


---

## Шаг 2: Детальное проектирование

### Модель данных
Хранить сопоставления `<shortURL, longURL>` в реляционной базе данных для эффективного использования памяти. Схема таблицы включает:
- `id` (первичный ключ),
- `shortURL`,
- `longURL`.

    <img src="./images/table-schema.png" alt="Table Schema" width="300">

### Хеш-функция
#### 1. Преобразование в Base 62
- Кодирует числа с использованием символов `[0-9, a-z, A-Z]`, предоставляя **62 возможных символа**.
- Преобразование основанием — еще один подход, часто используемый для сокращения URL.
- Уникальный идентификатор можно присвоить короткому URL, а затем преобразовать его в Base 62 для получения сокращенного URL.
- 7-символьный хеш поддерживает до **3,5 триллионов уникальных URL**, что достаточно для 365 миллиардов URL.

**Пример:**
Преобразовать ID `2009215674938` в Base 62:
`2009215674938` → `zn9edcu`.

#### 2. Хеш + разрешение коллизий
- Использовать хеш-функции, такие как CRC32, MD5 или SHA-1.

    <img src="./images/hash-function.png" alt="Hash Function" width="500">

- Один подход — использовать первые 7 символов значения хеша; однако этот метод может привести к коллизиям.
- Для разрешения коллизий постепенно добавлять заранее определённую строку, пока коллизии не будут устранены, но это может быть дорогостоящим.
- Разрешать коллизии с помощью **фильтров Блума** для эффективного поиска.

    <p align="center">
    <img src="./images/url-lookup.png" alt="URL Lookup" width="500">
    </p>

### Сравнение

- **Хеш + разрешение коллизий:**
  - Фиксированная длина короткого URL
  - Не требует генератора уникальных идентификаторов
  - Коллизии возможны и требуют разрешения
  - Невозможно найти следующий доступный короткий URL, поскольку он не зависит от идентификатора

- **Преобразование в Base 62**
  - Длина не фиксирована и растет с увеличением идентификатора
  - Требуется генератор уникальных идентификаторов
  - Коллизии исключены
  - Легко найти следующий короткий URL, если идентификатор инкрементируется на 1 (может представлять угрозу безопасности)


---

## Процесс сокращения URL

<p align="center">
    <img src="./images/url-shortening-flow.png" alt="URL Shortening" width="500">
</p>

1. Проверить, существует ли `longURL` в базе данных.
2. Если найден, вернуть существующий `shortURL`.
3. В противном случае:
   - Сгенерировать уникальный идентификатор с помощью **распределенного генератора идентификаторов**.
   - Преобразовать идентификатор в `shortURL` с помощью Base 62.
   - Сохранить сопоставление `<id, shortURL, longURL>` в базе данных.



---

## Процесс перенаправления URL
<p align="center">
    <img src="./images/url-redirecting-flow.png" alt="URL Shortening" width="600">
</p>

1. Пользователь кликает по `shortURL`.
2. Выполнить запрос сопоставления `<shortURL, longURL>`:
   - Сначала проверить **кеш** для ускорения доступа.
   - Если нет в кеше, выполнить запрос к базе данных.
3. Перенаправить пользователя на `longURL`.


---

## Дополнительные соображения
### Ограничитель скорости
- Предотвращать злоупотребления путем установки ограничений на количество запросов с одного IP.

### Масштабируемость
1. **Веб-уровень:** Без состояний, масштабируется путем добавления/удаления веб-серверов.
2. **Уровень базы данных:** Использовать репликацию и шардинг.

### Аналитика
- Собирать данные, такие как количество кликов, источник и временные метки для бизнес-аналитики.

### Высокая доступность и надежность
- Обеспечить согласованные и надежные сервисы с помощью репликации базы данных и отказоустойчивого дизайна.
