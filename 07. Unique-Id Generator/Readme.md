# Глава 7: Проектирование генератора уникальных идентификаторов в распределенных системах

## Введение
Этот раздел рассматривает задачу проектирования **генератора уникальных идентификаторов** для распределенных систем. Традиционные автоинкрементные ключи не подходят в распределенных средах из-за проблем масштабируемости и синхронизации. Основная задача — создать уникальные, сортируемые, 64-битные числовые идентификаторы, которые соответствуют следующим требованиям:
- Идентификаторы должны быть **уникальными** и **упорядоченными по дате**.
- Идентификаторы должны помещаться в **64 бита**.
- Система должна генерировать **более 10,000 идентификаторов в секунду**.

---

## Шаг 1: Понимание задачи
### Основные требования
- Идентификаторы должны быть уникальными, числовыми и помещаться в 64 бита.
- Идентификаторы увеличиваются со временем, но не строго на `+1`.
- Идентификаторы должны быть сортируемыми по дате.
- Система должна обеспечивать высокую пропускную способность (10,000 идентификаторов/с).

---

## Шаг 2: Варианты высокоуровневого проектирования
### 1. Много-мастеровая репликация
- **Подход:** Использовать `auto_increment` базы данных с шаговым приращением (например, `+k` для k серверов).

    <p align="left">
    <img src="./images/multi-master.png" alt="Multi Master" width="400">
    </p>

- **Недостатки:**
  - Сложно масштабировать между дата-центрами.
  - Идентификаторы не всегда возрастают во времени.
  - Проблемы масштабирования при добавлении/удалении серверов.

### 2. UUID (универсальный уникальный идентификатор)
- **Подход:**
    - Генерировать 128-битные уникальные идентификаторы независимо на каждом сервере с помощью UUID.
    - UUID можно генерировать независимо без координации между серверами.

        <p align="left">
        <img src="./images/uuid.png" alt="UUID generator" width="600">
        </p>

- **Преимущества:**
  - Не требуется координация между серверами.
  - Легко масштабируется с веб-серверами.
- **Недостатки:**
  - Превышает требование в 64 бита.
  - Идентификаторы не сортируются по времени и могут быть нечисловыми.


### 3. Ticket-сервер
- **Подход:** Использовать централизованный сервер базы данных для инкрементации и назначения идентификаторов.

    <p align="left">
    <img src="./images/ticket-server.png" alt="UUID generator" width="500">
    </p>

- **Преимущества:**
  - Простая реализация для систем малого масштаба.
  - Генерирует числовые идентификаторы.
- **Недостатки:**
  - Единая точка отказа.
  - Проблемы синхронизации в многосерверных конфигурациях.

### 4. Метод Twitter Snowflake
- **Подход:**

    <div style="margin-left:3rem">
      <img src="./images/twitter-snowflake.png" alt="Snowflake approach" width="500">
    </div>
    <div style="margin-left:3rem">
      <img src="./images/snowflake-id-breakdown.png" alt="Snowflake ID breakdown" width="500">
    </div>

    - Разбить идентификаторы на секции для обеспечения уникальности и масштабируемости.
    - **Бит знака (1 бит):** Всегда `0`, используется для различия знаковых и беззнаковых чисел.
    - **Отметка времени (41 бит):** Миллисекунды с момента пользовательской эпохи (по умолчанию у Twitter — `1288834974657`, что соответствует 4 ноября 2010 года, 01:42:54 UTC). Обеспечивает сортировку по времени.
    - **ID дата-центра (5 бит):** Идентифицирует до `2^5 = 32` дата-центров.
    - **ID машины (5 бит):** Идентифицирует до `2^5 = 32` машин в каждом дата-центре.
    - **Номер последовательности (12 бит):** Считает идентификаторы, генерируемые на одной машине в пределах одной миллисекунды, поддерживая до `2^12 = 4096` идентификаторов за миллисекунду. Последовательность сбрасывается в `0` каждую миллисекунду.



- **Преимущества:**
    - **Масштабируемость:** Обрабатывает более 10,000 идентификаторов в секунду на нескольких серверах.
    - **Сортировка по времени:** Гарантирует, что идентификаторы сортируются по времени.
    - **Децентрализация:** Нет единой точки отказа.


## Шаг 4: Дополнительные соображения
### 1. Синхронизация часов
- **Проблема:** Генерация идентификаторов предполагает синхронизированные часы на серверах.
- **Решение:** Использовать **протокол сетевого времени (NTP)** для минимизации дрейфа.

### 2. Настройка размеров секций
- Регулировать размеры секций (например, уменьшить количество бит для последовательности, увеличить для отметки времени) в зависимости от случая использования.

### 3. Высокая доступность
- Генераторы идентификаторов являются критически важными и должны быть отказоустойчивыми.
- Рассмотреть механизмы резервирования и переключения при сбое.

