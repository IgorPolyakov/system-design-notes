# Глава 2: Приблизительная оценка

## Введение
Приблизительная оценка — важнейший навык на собеседованиях по системному дизайну. Это включает быстрые, грубые вычисления для оценки ёмкости системы или производительности. По словам Джеффа Дина, старшего научного сотрудника Google, такие оценки помогают понять, соответствует ли дизайн требованиям, с помощью мысленных экспериментов и типовых показателей производительности.

Эта глава охватывает ключевые понятия, методики и примеры, помогающие развить навыки масштабирования и оценки.

---

## Раздел 1: Ключевые понятия

### Степени двойки
Понимание объёмов данных в степенях двойки — основа точных расчётов хранилища и пропускной способности:

<img src="./images/power-of-two.png" alt="power-of-two" width="500" />

---

### Задержки, которые должен знать каждый программист
Значения задержек показывают время выполнения различных операций в вычислительных системах. Это помогает понять относительную производительность:

| Операция                      | Задержка (2020) |
|------------------------------|-----------------|
| Доступ к L1 кэшу             | 0.5 нс          |
| Доступ к L2 кэшу             | 7 нс            |
| Доступ к основной памяти     | 100 нс          |
| Случайное чтение с SSD       | 150 мкс         |
| Случайное позиционирование HDD| 10 мс           |
| Запрос в пределах дата-центра| 500 мкс         |
| Запрос между регионами       | 150 мс          |

**Основные выводы:**
- Память быстрая, диск медленный.
- По возможности избегайте обращений к диску.
- Сжимайте данные перед передачей по сети для экономии трафика.


---

### Показатели доступности
Высокая доступность (HA) обеспечивает минимальное время простоя. Доступность выражается в **девятках**:
- **99% (две девятки):** ~3.65 дней простоя в год
- **99.9% (три девятки):** ~8.8 часов простоя в год
- **99.99% (четыре девятки):** ~52 минут простоя в год
- **99.999% (пять девяток):** ~5.3 минут простоя в год
- **99.9999% (шесть девяток):** ~31.56 секунд простоя в год


Облачные провайдеры, такие как Amazon, Google и Microsoft, стремятся обеспечить SLA (гарантии уровня обслуживания) **99.9% и выше**.

---

## Раздел 2: Пример оценки — QPS и требования к хранилищу Twitter

### Предположения
- **300 миллионов активных пользователей в месяц (MAU).**
- **50% активных пользователей в день (DAU).**
- **В среднем 2 твита на пользователя в день.**
- **10% твитов содержат медиа.**
- **Хранение данных: 5 лет.**

### Оценки
1. **Запросы в секунду (QPS):**
   - DAU = 300M x 50% = 150M
   - QPS для твитов = 150M x 2 твита / 24 часа / 3600 секунд = ~3500
   - Пиковый QPS = 2 x 3500 = ~7000

2. **Хранение медиа:**
   - **Размер твита:**
     - `tweet_id`: 64 байта
     - `text`: 140 байт
     - `media`: 1 МБ
   - **Медиа в день:** 150M x 2 x 10% x 1MB = 30TB в день
   - **За 5 лет:** 30TB x 365 x 5 = ~55PB

---

## Раздел 3: Советы для эффективной оценки

### 1. Округление и приближение
Точность не критична — важно показать процесс. Упрощайте вычисления, используя округлённые числа. Например:
- 99987 / 9.1 можно округлить до 100000 / 10 = 10000

### 2. Записывайте предположения
Фиксируйте предположения явно, чтобы можно было к ним вернуться.

### 3. Указывайте единицы
Во избежание недопонимания обязательно отмечайте единицы (например, `5 МБ`, а не просто `5`).

### 4. Часто встречающиеся сценарии оценки
- **QPS (запросов в секунду):** измерение интенсивности трафика.
- **Пиковый QPS:** учёт пиковых нагрузок.
- **Объём хранилища:** оценка общей потребности в данных.
- **Кэш:** оценка объёма памяти под кэширование.
- **Количество серверов:** расчёт необходимого оборудования по нагрузке.

